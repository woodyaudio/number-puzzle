<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
    // 1. ì—¬ê¸°ì— Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ë³¸ì¸ì˜ ì„¤ì •ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
const firebaseConfig = {
  apiKey: "AIzaSyB_NUeTdKb8amEQgpIiH2s01EvOw0fywOE",
  authDomain: "project-number-2e9c8.firebaseapp.com",
  databaseURL: "https://project-number-2e9c8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "project-number-2e9c8",
  storageBucket: "project-number-2e9c8.firebasestorage.app",
  messagingSenderId: "419237880538",
  appId: "1:419237880538:web:5055d7133ef62bab23fbe3",
  measurementId: "G-V2XXPMSD0K"
};

    // Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. ì ìˆ˜ ì €ì¥ í•¨ìˆ˜ (í†µí•© ì„œë²„ ì €ì¥)
    function saveScore(name, level) {
        // ê¸°ì¡´ localStorage ëŒ€ì‹  Firebaseì— ì €ì¥
        // ë‹‰ë„¤ì„ ì¤‘ íŠ¹ìˆ˜ë¬¸ì ì œê±° (Firebase ê²½ë¡œ ë¬¸ì œ ë°©ì§€)
        const safeName = name.replace(/[.#$[\]]/g, "_");
        const userScoreRef = db.ref(`scores/level${level}/${safeName}`);

        userScoreRef.once('value', (snapshot) => {
            const currentCount = snapshot.val() || 0;
            userScoreRef.set(currentCount + 1); // ìŠ¹ë¦¬ íšŸìˆ˜ 1 ì¦ê°€
        });
    }

    // 3. ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜ (ì‹¤ì‹œê°„ ë™ê¸°í™”)
    function updateRankDisplay() {
        const levelKey = 'level' + currentLevel;
        const rankTitle = document.getElementById('rank-title');
        const rankList = document.getElementById('rank-list');
        const winnerSpan = document.getElementById(`winner-${currentLevel}`);

        rankTitle.innerText = `${currentLevel}ë‹¨ê³„ ë­í‚¹ (ì‹¤ì‹œê°„)`;

        // Firebaseì—ì„œ í•´ë‹¹ ë ˆë²¨ì˜ ì ìˆ˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°ì‹œ
        db.ref(`scores/${levelKey}`).orderByValue().limitToLast(10).on('value', (snapshot) => {
            const data = snapshot.val();
            const sorted = [];
            for (let name in data) {
                sorted.push([name, data[name]]);
            }
            // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
            sorted.sort((a, b) => b[1] - a[1]);

            rankList.innerHTML = sorted.length ? '' : '<div style="font-size:0.8rem; opacity:0.5;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            
            sorted.forEach((item, index) => {
                let crown = index === 0 ? "ğŸ‘‘" : index === 1 ? "ğŸ¥ˆ" : index === 2 ? "ğŸ¥‰" : (index + 1) + ".";
                let colorClass = index === 0 ? "gold" : index === 1 ? "silver" : index === 2 ? "bronze" : "";
                
                // 1ë“± ì „ê´‘íŒ ì—…ë°ì´íŠ¸ (í˜„ì¬ ë³´ê³  ìˆëŠ” ë ˆë²¨ì˜ 1ë“±)
                if (index === 0) {
                    document.getElementById(`winner-${currentLevel}`).innerText = item[0];
                }

                rankList.innerHTML += `
                    <div class="rank-item">
                        <span class="${colorClass}"><i class="crown">${crown}</i>${item[0]}</span>
                        <span>${item[1]}íšŒ</span>
                    </div>`;
            });
        });
        
        // ëª¨ë“  ë ˆë²¨ì˜ 1ë“± ì´ë¦„ ì´ˆê¸°í™” (ë²„íŠ¼ ì˜† í‘œì‹œìš©)
        [1, 2, 3].forEach(lvl => {
            db.ref(`scores/level${lvl}`).orderByValue().limitToLast(1).once('value', (snap) => {
                const d = snap.val();
                if(d) {
                    const name = Object.keys(d)[0];
                    document.getElementById(`winner-${lvl}`).innerText = name;
                }
            });
        });
    }

    // ... ë‚˜ë¨¸ì§€ ê²Œì„ ë¡œì§(generateBoard, drawLine ë“±)ì€ ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ ...
</script>